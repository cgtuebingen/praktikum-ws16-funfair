<!DOCTYPE html>
<html>
<head>
    <title>Funfair</title>
    <meta charset="UTF-8">

    <style>

        body {
            overflow: hidden;
            margin: 0;
        }

        section {
            display: block;
            overflow: scroll;
            overflow-x: hidden;
        }

        #canvas {
            position: fixed;
            right: 80px;
            top: 100px;
        }

    </style>

</head>
<body>

<canvas id="canvas" height="400" width="40"></canvas>

<section>
    <iframe style="width:100%;height:1000px;" src="../design/carusell.html"></iframe>
</section>

<section>
    <iframe style="width:100%;height:1000px;" src="../code/painter/painter.html"></iframe>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:#050"></span>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:#228822"></span>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:#624144"></span>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:#ff00FF"></span>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:#c00"></span>
</section>

<section>
    <span style="display: block;height:1000px;width:2000px;background:yellow"></span>
</section>


<script>

    (function (window) {

        var document = window.document;

        var body = document.body;

        var sections = document.getElementsByClassName("section");

        var clientHeight;
        var currentStep = 0;
        var questionsAnswered = 0;

        document.onclick = function () {

            var start = NOW;

            if (questionsAnswered === sections.length - 1)
                return;

            currentStep++;
            questionsAnswered++;

            $anim['scroll'] = function (now) {

                var state = (now - start) / 750;

                if (state >= 1) {
                    state = 1;
                    delete $anim['scroll'];
                    drawProgress();
                }

                state = --state * state * state + 1;

                body.scrollTop = (state + currentStep - 1) * clientHeight;
            };
        };

        window.onbeforeunload = function() {
            body.scrollTop = 0;
        }

        var resizeTime = null;
        window.onresize = function () {

            if (resizeTime !== null)
                window.clearTimeout(resizeTime);

            resizeTime = window.setTimeout(function () {

                resizeSections();

                body.scrollTop = currentStep * clientHeight;
            }, 50);
        };



        function resizeSections() {

            clientHeight = window.innerHeight;

            var elm = sections;
            for (var i = elm.length; i--;) {
                elm[i].style.height = clientHeight + "px";
            }
        }

        var drawProgress = function () {

            var width = 40;
            var center = width / 2;
            var height = 400 - 2 * center;

            ctx.clearRect(0, 0, 40, 400);

            // Gets a matrix of from-to steps on the progressbar for 3 segments (2x green, 1x white)
            var segmentMatrix = [0, currentStep, currentStep, questionsAnswered, questionsAnswered, sections.length - 1];

            function segment(part) {

                var off = 0;

                var partner = (part % 2 === 0 ? part + 1 : part - 1);

                if (segmentMatrix[part] === segmentMatrix[partner]) {
                    return 0;
                }

                if (part === 1) // first green end
                    off = -9;

                if (part === 2) // second green start
                    off = 9;

                if (part === 4 && currentStep === questionsAnswered) // white start
                    off = 9;

                // Get the current height by segment
                return center + segmentMatrix[part] * height / (sections.length - 1) + off;
            }

            ctx.lineWidth = 4;
            ctx.strokeStyle = "#4c7938";
            ctx.beginPath();
            ctx.moveTo(center, segment(0));
            ctx.lineTo(center, segment(1));
            ctx.moveTo(center, segment(2));
            ctx.lineTo(center, segment(3));
            ctx.stroke();

            ctx.strokeStyle = "#fff";
            ctx.beginPath();
            ctx.moveTo(center, segment(4));
            ctx.lineTo(center, segment(5));
            ctx.stroke();

            for (var i = 0; i < sections.length; i++) {

                var x = center;
                var y = center + i * height / (sections.length - 1);

                if (i === currentStep) {
                    ctx.lineWidth = 11;
                    ctx.strokeStyle = "#4c7938";
                    ctx.beginPath();
                    ctx.arc(x, y, 14, 0, Math.PI * 2, false);
                    ctx.stroke();
                } else if (i <= questionsAnswered) {
                    ctx.fillStyle = "#4c7938";
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2, false);
                    ctx.fill();
                } else {
                    ctx.fillStyle = "#fff";
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, Math.PI * 2, false);
                    ctx.fill();
                }
            }
        };

        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext("2d");

        var NOW;
        var $anim = {};
        var loop = function (now) {
            NOW = now;
            for (var i in $anim) {
                $anim[i](now);
            }
            window.requestAnimationFrame(loop);
        };

        resizeSections();
        drawProgress();

        window.requestAnimationFrame(loop);

    })(this);


</script>

</body>
</html>
